<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <title>Full Stack Caf√©</title>
  </head>
  <body>
    <%- include('partials/header') %>

    <div class="bg-gray-50 min-h-screen py-12">
      <div class="max-w-6xl mx-auto px-4">
        <h1 class="text-4xl font-black text-gray-900 mb-8">Your Bag</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 space-y-4" id="cart-items-container">
            <div
              class="bg-white p-12 rounded-3xl text-center border border-dashed border-gray-200"
            >
              <p class="text-gray-500">Checking your bag...</p>
            </div>
          </div>

          <div class="lg:col-span-1">
            <div
              class="bg-white rounded-3xl p-6 shadow-sm border border-gray-100 sticky top-24"
            >
              <h2 class="text-xl font-bold mb-6 text-gray-800">
                Order Summary
              </h2>

              <div class="space-y-4 mb-6">
                <div class="flex justify-between text-gray-600">
                  <span>Subtotal</span>
                  <span id="subtotal">‚Çπ0</span>
                </div>
                <div class="flex justify-between text-gray-600">
                  <span>Platform Fee</span>
                  <span>‚Çπ5</span>
                </div>
                <hr class="border-gray-100" />
                <div
                  class="flex justify-between text-xl font-black text-red-700"
                >
                  <span>Total</span>
                  <span id="total-amount">‚Çπ0</span>
                </div>
              </div>

              <button
                onclick="placeOrder()"
                class="w-full bg-red-700 text-white py-4 rounded-2xl font-bold hover:bg-red-800 transition shadow-lg shadow-red-200 flex items-center justify-center gap-2"
              >
                Confirm Order
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 1. Render Cart Items from LocalStorage
      function renderCart() {
        const cart = JSON.parse(localStorage.getItem("cart")) || [];
        const container = document.getElementById("cart-items-container");

        if (cart.length === 0) {
          container.innerHTML = `
        <div class="bg-white p-20 rounded-3xl text-center border border-dashed border-gray-200">
          <div class="text-5xl mb-4">üõçÔ∏è</div>
          <p class="text-gray-500 mb-6">Your bag is empty.</p>
          <a href="/products" class="bg-red-700 text-white px-8 py-3 rounded-full font-bold hover:bg-red-800 transition shadow-lg shadow-red-200">
            Browse Menu
          </a>
        </div>`;
          // Reset totals
          document.getElementById("subtotal").innerText = "‚Çπ0";
          document.getElementById("total-amount").innerText = "‚Çπ0";
          return;
        }

        let html = "";
        let subtotal = 0;

        cart.forEach((item, index) => {
          subtotal += item.price * item.quantity;
          html += `
        <div class="bg-white p-6 rounded-3xl flex items-center gap-6 border border-gray-50 shadow-sm">
          <img src="/images/${
            item.image
          }" class="w-24 h-24 rounded-2xl object-cover" onerror="this.src='https://placehold.co/100x100?text=Food'">
          <div class="flex-1">
            <h3 class="font-bold text-lg text-gray-800">${item.name}</h3>
            <p class="text-gray-500">‚Çπ${item.price} each</p>
          </div>
          <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-xl">
            <button onclick="updateQty('${
              item.id
            }', -1)" class="w-8 h-8 bg-white rounded-lg shadow-sm font-bold hover:bg-red-50 hover:text-red-700 transition">-</button>
            <span class="font-bold w-6 text-center text-gray-800">${
              item.quantity
            }</span>
            <button onclick="updateQty('${
              item.id
            }', 1)" class="w-8 h-8 bg-white rounded-lg shadow-sm font-bold hover:bg-red-50 hover:text-red-700 transition">+</button>
          </div>
          <p class="font-black text-gray-900 w-24 text-right">‚Çπ${
            item.price * item.quantity
          }</p>
        </div>`;
        });

        container.innerHTML = html;
        document.getElementById("subtotal").innerText = "‚Çπ" + subtotal;
        // Platform fee is 5, only if cart is not empty
        document.getElementById("total-amount").innerText =
          "‚Çπ" + (subtotal + 5);
      }

      // 2. Optimized Update Quantity Logic
      function updateQty(productId, change) {
        let cart = JSON.parse(localStorage.getItem("cart")) || [];
        const itemIndex = cart.findIndex((item) => item.id === productId);

        if (itemIndex > -1) {
          cart[itemIndex].quantity += change;

          // Remove item if quantity drops to 0
          if (cart[itemIndex].quantity <= 0) {
            cart.splice(itemIndex, 1);
          }

          localStorage.setItem("cart", JSON.stringify(cart));

          // Refresh the current UI
          renderCart();

          // REUSE: Global function from header script to update the nav badge
          if (typeof updateCartBadge === "function") {
            updateCartBadge();
          }
        }
      }

      // 3. Send Cart to Server (Checkout)
      async function placeOrder() {
        // 1. Get and Validate Cart
        const cart = JSON.parse(localStorage.getItem("cart")) || [];

        if (cart.length === 0) {
          showToast("Your bag is empty!", "error");
          return;
        }

        // 2. Prepare Data (Only send what the server needs to verify)
        const orderData = {
          items: cart.map((item) => ({
            productId: item.productId,
            quantity: item.quantity,
          })),
        };

        try {
          // 3. Send Request
          const response = await fetch("/api/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderData),
          });

          // 4. Handle Response
          const data = await response.json(); // Define data here so it's available for both blocks

          if (response.ok) {
            // Success Logic
            localStorage.removeItem("cart");

            if (typeof updateCartBadge === "function") {
              updateCartBadge();
            }

            showToast(data.message || "Order placed successfully!", "success");

            // Redirect after a short delay
            setTimeout(() => {
              window.location.href = "/orders";
            }, 1500);
          } else {
            // Error Handling
            if (response.status === 401) {
              showToast("Please login to checkout", "error");
              setTimeout(() => (window.location.href = "/login"), 1000);
            } else {
              showToast(data.error || "Failed to place order", "error");
            }
          }
        } catch (err) {
          console.error("Checkout Error:", err);
          showToast("Network error. Please check your connection.", "error");
        }
      }
      // Initial render
      document.addEventListener("DOMContentLoaded", renderCart);
    </script>

    <%- include('partials/footer') %>
  </body>
</html>
